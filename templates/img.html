{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid text-center">
    <div class="row mt-5">
        <div class="col">
            <h1>Detector de armas</h1>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col text-center">
            <label class="h1">→ Imagen</label>
        </div>
    </div>
    <!-- <div class="row mt-2">
        <div class="col-4"></div>
        <div class="col-2 text-end">
            <label class="h3">Video</label>
        </div>
        <div class="col">
            <a type="button" class="btn btn-primary" href="{% url 'video' %}">→</a>
        </div>
        <div class="col-5"></div>
    </div> -->
    <form class="form-inline" method="POST" enctype="multipart/form-data" id="enviooo">
        {% csrf_token %}
        <div class="row mt-4 justify-content-md-center">
            <div class="col-3">
                {{ form.img_to_p }}
            </div>
            <div class="col-1">
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </div>
    </form>

    {% if img %}
        <div class="row mt-4 justify-content-md-center" id="showinggg">
            <div class="col-4">
                <img src="data:image/png;base64, {{ img|safe }}" alt="detectado">
            </div>
        </div>       
    {% endif %}
    <div class="row mt-5 justify-content-md-center" id="spinnerrr" hidden>
        <div class="spinner-grow mt-5 text-primary" role="status">
            <span class="sr-only mt-5"></span>
        </div>
    </div>
    <p id="errorTxt"></p>
    <div>
        <video id="theVideo" controls autoplay></video>
        <canvas id="theCanvas"></canvas>
    </div>
    <button id="btnCapture">Tomar foto</button>
    <button id="btnDownloadImage">Descargar imagen</button>
    <script type="text/javascript">
        var videoWidth = 225;
        var videoHeight = 225;
        var videoTag = document.getElementById('theVideo');
        var canvasTag = document.getElementById('theCanvas');
        var btnCapture = document.getElementById("btnCapture");
        var btnDownloadImage = document.getElementById("btnDownloadImage");
        videoTag.setAttribute('width', videoWidth);
        videoTag.setAttribute('height', videoHeight);
        canvasTag.setAttribute('width', videoWidth);
        canvasTag.setAttribute('height', videoHeight);
        window.onload = () => {
            navigator.mediaDevices.getUserMedia({
                audio: true,
                video: {
                    width: videoWidth,
                    height: videoHeight
                }
            }).then(stream => {
                videoTag.srcObject = stream;
            }).catch(e => {
                document.getElementById('errorTxt').innerHTML = 'ERROR: ' + e.toString();
            });
            var canvasContext = canvasTag.getContext('2d');
            btnCapture.addEventListener("click", () => {
                canvasContext.drawImage(videoTag, 0, 0, videoWidth, videoHeight);
            });
            btnDownloadImage.addEventListener("click", () => {
                var link = document.createElement('a');
                link.download = 'capturedImage.png';
                link.href = canvasTag.toDataURL();
                link.click();
            });
        };
    </script>
</div>

<script src="{% static 'js/loader.js' %}"></script>
{% endblock %}